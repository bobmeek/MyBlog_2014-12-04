<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.myblog.model.ArticleVO">
	  
	<resultMap type="article" id="articleResultMap">
		<id property="id" column="aid" />
		<result property="title" column="title" />
		<result property="author" column="author" />
		<result property="content" column="content" />
		<result property="releaseDate" column="release_date" />
		<result property="readCount" column="read_count" />
		<result property="commentCount" column="comment_count" />
		<result property="topLevel" column="top_level" />
		<result property="privacy" column="privacy" />
		<result property="categoryId" column="id_category" />
		<result property="menuId" column="id_menu" />
		<association property="menu"  resultMap="org.myblog.model.MenuVO.menuResultMap"/>
		<!-- <association property="menu" javaType="menu">  
			<id property="id" column="id" />
	        <result property="name" column="name" />  
    	</association>   -->
		<!-- <association property="category" javaType="category">Article和CategoryN-1表示关联
			<id property="id" column="id" />
			<result property="name" column="name" />
			<result property="parentId" column="parent_id" />
		</association> -->
	</resultMap>
	
	<!-- 查询操作。查询文章信息|栏目信息|标签信息 -->
	<select id="findAll"  resultMap="articleResultMap" >
		select a.id as aid,a.title,a.author,a.content,a.release_date,a.read_count,a.top_level,a.privacy,a.`id_menu`,m.name,c.name,t.tag_name from article a left join category c on a.id_category=c.id left join tag t
		on a.id_tag_article_tag=t.id LEFT JOIN menu m ON a.`id_menu`=m.`id` ORDER BY a.release_date DESC
	</select>
		
	<select id="findListByMenuId" resultMap = "articleResultMap">
		SELECT a.id AS aid,a.title,a.author,a.content,a.release_date,a.read_count,a.top_level,a.privacy,a.`id_menu`,c.name,t.tag_name,a.`id_menu`,m.name FROM article a LEFT JOIN category c ON a.id_category=c.id LEFT JOIN tag t
		ON a.id_tag_article_tag=t.id LEFT JOIN menu m ON a.`id_menu`=m.`id` WHERE a.`id_menu`=#{menuId} ORDER BY a.release_date DESC 
	</select>
	
	<!-- 文章分页查询 -->
	<select id="findByPage" resultMap="articleResultMap" parameterType="map">
		select a.id as aid,a.title,a.author,a.content,a.release_date,a.read_count,a.top_level,a.privacy,a.`id_menu`,m.* from article a 
		LEFT JOIN menu m ON a.`id_menu`=m.`id` ORDER BY a.release_date DESC limit #{pageNo},#{pageSize}
	</select>
	<select id="findPageByMenuId" resultMap="articleResultMap" parameterType="map">
		select a.id as aid,a.title,a.author,a.content,a.release_date,a.read_count,a.top_level,a.privacy,a.`id_menu`,m.* from article a 
		LEFT JOIN menu m ON a.`id_menu`=m.`id` where id_menu=#{menuId} ORDER BY a.release_date DESC limit #{pageNo},#{pageSize}
	</select>
	
	<!-- 查询文章列表总数 -->
	<select id="findTotal" resultType="int" parameterType="int">
		select count(*) from article
	</select>
	
	<select id="findTotalByMenuId" resultType="int" parameterType="int">
		select count(*) from article where id_menu = #{menuId}
	</select>
	
	
	
	<!-- 删除操作。根据文章id删除文章信息 -->
	<delete id="delete" parameterType="int">
		delete from article where id=#{id}
	</delete>
	
	<!-- 查询操作。根据文章id查询文章信息 -->
	<select id="findById" resultMap="articleResultMap">
		select a.id as aid,a.title,a.author,a.content,a.release_date,a.read_count,a.top_level,a.privacy,a.`id_menu`,c.name,t.tag_name from article a left join category c on a.id_category=c.id left join tag t
		on a.id_tag_article_tag=t.id LEFT JOIN menu m ON a.`id_menu`=m.`id` where a.id=#{id}
	</select>
	
	<!-- 查询操作。根据文章标题模糊查询文章信息，并且根据文章发布日期排序文章 -->
	<select id="searchArticleByTitle" resultMap="articleResultMap" parameterType="map">
		<!-- select a.id,a.title,a.author,a.release_date,c.name,t.tag_name from article as a,category as c,article_tag as art,tag as t 
		where a.id_tag_article_tag=art.id_tag and art.id_tag=t.id and a.title like '%${title}%' ORDER BY a.release_date DESC -->
		select a.id,a.title,a.author,a.release_date,a.`id_menu`,a.privacy,c.name,t.tag_name from article as a,category as c,article_tag as art,tag as t 
		where a.id_category=c.id and a.id=art.id_article and art.id_tag=t.id and a.title like '%${title}%' ORDER BY a.release_date DESC
	</select>
	
	<!-- 批量删除文章操作 -->
	<delete id="bulk_delete" parameterType="java.util.List">
		<![CDATA[delete from article where id in]]><foreach collection="list" item="num"  open="(" separator="," close=")">#{num}</foreach>	
	</delete>
	
	<!-- 批量删除文章标签操作 -->
	<delete id="bulk_delete2" parameterType="java.util.List">
		<![CDATA[delete from article_tag where article_tag.id_article in]]>
		<foreach collection="list" item="num"  open="(" separator="," close=")">#{num}</foreach>	
	</delete>

	
	
	
	<!-- 插入操作。完成标题、内容、id_category、id_tag_article_tag、release_date的插入 -->
	<insert id="add"  parameterType="article" useGeneratedKeys="true" keyProperty="id">
		insert into article(title,content,id_menu,author,release_date,privacy) 
		values(#{title},#{content},#{menuId},#{author},#{releaseDate},#{privacy})
	</insert>
	
	<!-- 修改操作 -->
	<update id="update"  parameterType="article">
		update article set title=#{title},content=#{content},author=#{author},privacy=#{privacy},id_menu=#{menuId},release_date=#{releaseDate} where id=#{id} 
	</update>
	
</mapper>